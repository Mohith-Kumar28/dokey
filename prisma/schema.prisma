generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Document {
  id         String   @id @default(cuid())
  orgId      String
  ownerId    String
  owner      User     @relation(fields: [ownerId], references: [id])
  title      String
  status     String   @default("draft")
  docJson    Json?
  pdfUrl     String?  // URL to original PDF
  pdfPath    String?  // Storage path for PDF
  pageCount  Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  comments   Comment[]
  redlines   Redline[]
  recipients Recipient[]
  pages      DocumentPage[]
}

model Recipient {
  id             String   @id @default(cuid())
  docId          String
  document       Document @relation(fields: [docId], references: [id])
  email          String
  name           String
  role           String   @default("signer") // e.g. Sender, Client, Approver
  color          String   @default("#3b82f6") // Color for UI identification
  deliveryMethod String   @default("email") // Email, SMS, Link
  submittedAt    DateTime? // When recipient completed and submitted their fields
  createdAt      DateTime @default(now())
  fields         Field[]

  @@unique([docId, email])
}

model DocumentPage {
  id         String   @id @default(cuid())
  docId      String
  document   Document @relation(fields: [docId], references: [id], onDelete: Cascade)
  pageNumber Int
  imageUrl   String   // URL to page image
  width      Float
  height     Float
  fields     Field[]
  createdAt  DateTime @default(now())

  @@unique([docId, pageNumber])
}

model Field {
  id          String        @id @default(cuid())
  pageId      String
  page        DocumentPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  recipientId String?
  recipient   Recipient?    @relation(fields: [recipientId], references: [id])
  type        String        // text, signature, date, checkbox, etc.
  x           Float         // Position X
  y           Float         // Position Y
  width       Float
  height      Float
  required    Boolean       @default(false)
  label       String?
  value       String?
  properties  Json?         // Custom properties per field type
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Template {
  id         String   @id @default(cuid())
  orgId      String
  title      String
  description String?
  docJson    Json
  isSystem   Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model ContentBlock {
  id        String   @id @default(cuid())
  orgId     String
  key       String
  name      String
  blockJson Json
}

model Branding {
  id        String   @id @default(cuid())
  orgId     String
  logoUrl   String?
  fontsJson Json?
  colorsJson Json?
}

model Workflow {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  description String?
  steps     WorkflowStep[]
}

model WorkflowStep {
  id           String   @id @default(cuid())
  workflowId   String
  workflow     Workflow  @relation(fields: [workflowId], references: [id])
  stepOrder    Int
  approverRoleKey String
  conditionsJson Json?
}

model Comment {
  id        String   @id @default(cuid())
  docId     String
  document  Document  @relation(fields: [docId], references: [id])
  userId    String
  blockId   String?
  text      String
  createdAt DateTime @default(now())
}

model Redline {
  id        String   @id @default(cuid())
  docId     String
  document  Document  @relation(fields: [docId], references: [id])
  userId    String
  blockId   String
  diffJson  Json
  createdAt DateTime @default(now())
}

model Lock {
  id               String   @id @default(cuid())
  docId            String
  blockId          String
  lockedByRoleKey  String
}

model SigningSession {
  id        String   @id @default(cuid())
  docId     String
  orgId     String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  signers   Signer[]
}

model Signer {
  id          String   @id @default(cuid())
  sessionId   String
  session     SigningSession @relation(fields: [sessionId], references: [id])
  recipientEmail String
  recipientName  String
  order        Int
  status       String   @default("pending")
  authMethod   String?
}

model SignatureEvent {
  id         String   @id @default(cuid())
  sessionId  String
  signerId   String
  type       String
  metaJson   Json?
  createdAt  DateTime @default(now())
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  docId      String
  sessionId  String?
  type       String
  metaJson   Json?
  createdAt  DateTime @default(now())
}

model User {
  id               String   @id @default(cuid())
  externalProviderId String  @unique
  email            String    @unique
  name             String?
  imageUrl         String?
  createdAt        DateTime  @default(now())
  lastActiveAt     DateTime?
  preferencesJson  Json?
  documents        Document[]
}